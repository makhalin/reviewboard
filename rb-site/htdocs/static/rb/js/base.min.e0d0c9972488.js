(function(){var once=function(evt,callback,context){var cb=_.bind(function(){this.off(evt,cb);callback.apply(context||this,arguments)},this);this.on(evt,cb)};Backbone.Events.once=once;Backbone.Model.prototype.once=once;Backbone.Collection.prototype.once=once;Backbone.View.prototype.once=once;var checkIfObject;if(!Object.getPrototypeOf){checkIfObject=function(obj){if(obj!==Object(obj)){throw new TypeError("Object.getPrototypeOf called on non-object")}};if(typeof"test".__proto__==="object"){Object.getPrototypeOf=function(obj){checkIfObject(obj);return obj.__proto__}}else{Object.getPrototypeOf=function(obj){checkIfObject(obj);return obj.constructor.prototype}}}var _origAssert;if(typeof window.console==="undefined"){window.console={}}_origAssert=console.assert;if(typeof console.log==="undefined"){console.log=function(){}}if(typeof console.warn==="undefined"){console.warn=function(){}}if(typeof console.error==="undefined"){console.error=function(){}}console.assert=function(conditional,msg){if(_origAssert&&_origAssert.call){_origAssert.call(console,conditional,msg)}if(!conditional){throw new Error(msg)}};var DEFAULT_WRAPPED_CALLBACKS=["success","error","complete"];_.bindCallbacks=function(callbacks,context,methodNames){var wrappedCallbacks;if(!context){return callbacks}if(!methodNames){methodNames=DEFAULT_WRAPPED_CALLBACKS}wrappedCallbacks={};_.each(callbacks,function(value,key){wrappedCallbacks[key]=_.isFunction(callbacks[key])?_.bind(callbacks[key],context):undefined});return _.defaults(wrappedCallbacks,callbacks)};_super=function(obj){return Object.getPrototypeOf(Object.getPrototypeOf(obj))};RB={};var gInfoBoxCache={};$.fn.infobox=function(id){var POPUP_DELAY_MS=500,HIDE_DELAY_MS=300,OFFSET_LEFT=-20,OFFSET_TOP=10,$infobox=$("#"+id);if($infobox.length===0){$infobox=$("<div/>").attr("id",id).hide();$(document.body).append($infobox)}function showInfobox(url,$target){$infobox.empty().html(gInfoBoxCache[url]).positionToSide($target,{side:"tb",xOffset:OFFSET_LEFT,yDistance:OFFSET_TOP,fitOnScreen:true}).fadeIn();$infobox.find(".gravatar").retinaGravatar()}function fetchInfobox(url,$target){if(!gInfoBoxCache[url]){$.get(url,function(responseText){gInfoBoxCache[url]=responseText}).done(function(){showInfobox(url,$target)})}else{showInfobox(url,$target)}}return this.each(function(){var $target=$(this),timeout=null,url=$target.attr("href")+"infobox/";$target.on("mouseover",function(){timeout=setTimeout(function(){fetchInfobox(url,$target)},POPUP_DELAY_MS)});$([$target[0],$infobox[0]]).on({mouseover:function(){if($infobox.is(":visible")){clearTimeout(timeout)}},mouseout:function(){clearTimeout(timeout);if($infobox.is(":visible")){timeout=setTimeout(function(){$infobox.fadeOut()},HIDE_DELAY_MS)}}})})};$.fn.user_infobox=function(){$(this).infobox("user_infobox");return this};$.fn.bug_infobox=function(){$(this).infobox("bug_infobox");return this};$(document).ready(function(){$(".user").user_infobox();$(".bug").bug_infobox();$("time.timesince").timesince();$(".gravatar").retinaGravatar()});RB.APIErrors={NO_ERROR:0,SERVICE_NOT_CONFIGURED:1,DOES_NOT_EXIST:100,PERMISSION_DENIED:101,INVALID_ATTRIBUTE:102,NOT_LOGGED_IN:103,LOGIN_FAILED:104,INVALID_FORM_DATA:105,MISSING_ATTRIBUTE:105,ENABLE_EXTENSION_FAILED:107,DISABLE_EXTENSION_FAILED:108,EXTENSION_INSTALLED:109,INSTALL_EXTENSION_FAILED:110,UNSPECIFIED_DIFF_REVISION:200,INVALID_DIFF_REVISION:201,INVALID_ACTION:202,INVALID_CHANGE_NUMBER:203,CHANGE_NUMBER_IN_USE:204,MISSING_REPOSITORY:205,INVALID_REPOSITORY:206,REPO_FILE_NOT_FOUND:207,INVALID_USER:208,REPO_NOT_IMPLEMENTED:209,REPO_INFO_ERROR:210,NOTHING_TO_PUBLISH:211,EMPTY_CHANGESET:212,SERVER_CONFIG_ERROR:213,BAD_HOST_KEY:214,UNVERIFIED_HOST_KEY:215,MISSING_USER_KEY:217,REPO_AUTHENTICATION_ERROR:218,DIFF_EMPTY:219,DIFF_TOO_BIG:220,FILE_RETRIEVAL_ERROR:221,HOSTINGSVC_AUTH_ERROR:222,GROUP_ALREADY_EXISTS:223,DIFF_PARSE_ERROR:224};RB.setActivityIndicator=function(status,options){var $activityIndicator=$("#activity-indicator"),$indicatorText=$activityIndicator.children(".indicator-text");if(status){if(RB.ajaxOptions.enableIndicator&&!options.noActivityIndicator){$indicatorText.text(options.type||options.type==="GET"?gettext("Loading..."):gettext("Saving..."));$activityIndicator.removeClass("error").show()}}else if(RB.ajaxOptions.enableIndicator&&!options.noActivityIndicator&&!$activityIndicator.hasClass("error")){$activityIndicator.delay(250).fadeOut("fast")}};RB.apiCall=function(options){var prefix=options.prefix||"",url=options.url||SITE_ROOT+prefix+"api"+options.path;function doCall(){var $activityIndicator=$("#activity-indicator"),data;if(options.buttons){options.buttons.attr("disabled",true)}RB.setActivityIndicator(true,options);data=$.extend(true,{url:url,data:options.data,dataType:options.dataType||"json",error:function(xhr,textStatus,errorThrown){var rsp=null,responseText;try{rsp=$.parseJSON(xhr.responseText)}catch(e){}if(rsp&&rsp.stat||xhr.status===204){if($.isFunction(options.success)){options.success(rsp,xhr.status)}return}responseText=xhr.responseText;$activityIndicator.addClass("error").text(gettext("A server error occurred.")).append($("<a/>").text(gettext("Show Details")).attr("href","#").click(function(){showErrorPage(xhr,responseText)})).append($("<a/>").text(gettext("Dismiss")).attr("href","#").click(function(){$activityIndicator.fadeOut("fast");return false}));if($.isFunction(options.error)){options.error(xhr,textStatus,errorThrown)}}},options);data.complete=function(xhr,status){if(options.buttons){options.buttons.attr("disabled",false)}RB.setActivityIndicator(false,options);if($.isFunction(options.complete)){options.complete(xhr,status)}$.funcQueue("rbapicall").next()};if(data.data===null||data.data===undefined||typeof data.data==="object"){data.data=$.extend({api_format:"json"},data.data||{})}if(options.form){options.form.ajaxSubmit(data)}else{$.ajax(data)}}function showErrorPage(xhr,data){var iframe=$("<iframe/>").width("100%"),requestData="(none)",doc;if(options.data){requestData=$.param(options.data)}$('<div class="server-error-box"/>').appendTo("body").append("<p><b>"+gettext("Error Code:")+"</b> "+xhr.status+"</p>").append("<p><b>"+gettext("Error Text:")+"</b> "+xhr.statusText+"</p>").append("<p><b>"+gettext("Request URL:")+"</b> "+url+"</p>").append("<p><b>"+gettext("Request Data:")+"</b> "+requestData+"</p>").append('<p class="response-data"><b>'+gettext("Response Data:")+"</b></p>").append(gettext('<p>There may be useful error details below. The following error page may be useful to your system administrator or when <a href="https://www.reviewboard.org/bugs/new/">reporting a bug</a>. To save the page, right-click the error below and choose "Save Page As," if available, or "View Source" and save the result as a <tt>.html</tt> file.</p>')).append(gettext("<p><b>Warning:</b> Be sure to remove any sensitive material that may exist in the error page before reporting a bug!</p>")).append(iframe).on("resize",function(){iframe.height($(this).height()-iframe.position().top)}).modalBox({stretchX:true,stretchY:true,title:gettext("Server Error Details")});doc=iframe[0].contentDocument||iframe[0].contentWindow.document;doc.open();doc.write(data);doc.close()}options.type=options.type||"POST";if(RB.ajaxOptions.enableQueuing&&options.type!=="GET"){$.funcQueue("rbapicall").add(doCall);$.funcQueue("rbapicall").start()}else{doCall()}};RB.storeAPIError=function(xhr){var rsp=null,text;try{rsp=$.parseJSON(xhr.responseText);text=rsp.err.msg}catch(e){text="HTTP "+xhr.status+" "+xhr.statusText}xhr.errorText=text;xhr.errorPayload=rsp};RB.ajaxOptions={enableQueuing:true,enableIndicator:true};Backbone.ajax=function(options){return RB.apiCall(options)};if(!XMLHttpRequest.prototype.sendAsBinary){XMLHttpRequest.prototype.sendAsBinary=function(datastr){var data=new Uint8Array(Array.prototype.map.call(datastr,function(x){return x.charCodeAt(0)&255}));XMLHttpRequest.prototype.send.call(this,data.buffer)}}RB.LinkifyUtils={linkifyURLs:function(text){return text.replace(/\b([a-z]+:\/\/[\-A-Za-z0-9+&@#\/%?=~_()|!:,.;]*([\-A-Za-z0-9+@#\/%=~_();|]|))/g,function(url){var extra="",parts=url.match(/^(.*)(&[a-z]+;|\))$/),openParen=url.match(/.*\(.*/);if(parts!==null&&openParen===null){url=parts[1];extra=parts[2]}return'<a target="_blank" href="'+url+'">'+url+"</a>"+extra})},linkifyReviewRequests:function(text,markdown){return text.replace(/(^|\s|&lt;|\(|\[|{)\/(r\/\d+(\/[\-A-Za-z0-9+&@#\/%?=~_()|!:,.;]*[\-A-Za-z0-9+&@#\/%=~_()|]*)?)/g,function(text,m1,m2){var extra="",url=m2,parts=url.match(/^(.*)(&[a-z]+;|\))$/),href;if(parts!==null){url=parts[1];extra=parts[2]}href=SITE_ROOT+url+(url.substr(-1)==="/"?"":"/");if(markdown){return m1+"[/"+url+"]("+href+")"+extra}else{return m1+'<a target="_blank" href="'+href+'">/'+url+"</a>"+extra}})},linkifyBugs:function(text,bugTrackerURL,markdown){if(bugTrackerURL){return text.replace(/\b(bug|issue) (#([^.,\s]+)|#?(\d+))/gi,function(text,m2,m3,bugnum1,bugnum2){var bugnum=bugnum1||bugnum2,href=bugTrackerURL.replace("--bug_id--",bugnum);if(markdown){return"["+text+"]("+href+")"}else{return'<a target="_blank" href="'+href+'">'+text+"</a>"}})}else{return text}},linkifyText:function(text,bugTrackerURL,isHTMLEncoded){if(!isHTMLEncoded){text=text.htmlEncode()}text=RB.LinkifyUtils.linkifyURLs(text);text=RB.LinkifyUtils.linkifyReviewRequests(text);text=RB.LinkifyUtils.linkifyBugs(text,bugTrackerURL);return text},linkifyChildren:function(el,bugTrackerURL){var node,nodeName,nextNode,newText;for(node=el.childNodes[0];node;node=nextNode){nextNode=node.nextSibling;if(node.nodeType===node.TEXT_NODE){if(node.textContent){newText=RB.LinkifyUtils.linkifyText(node.textContent,bugTrackerURL);if(newText!==node.textContent){$(node).replaceWith(newText)}}}else if(node.nodeType===node.ELEMENT_NODE){nodeName=node.nodeName.toLowerCase();if(nodeName!=="pre"&&nodeName!=="a"){RB.LinkifyUtils.linkifyChildren(node,bugTrackerURL)}}}}};RB.MathUtils={clip:function(value,minValue,maxValue){return Math.min(maxValue,Math.max(minValue,value))}};RB.KeyBindingsMixin={delegateKeyBindings:function(){this.$el.on("keypress.keybindings"+this.cid,_.bind(function(evt){var keyChar,keys,func;if(evt.altKey||evt.ctrlKey||evt.metaKey||evt.target.tagName==="INPUT"||evt.target.tagName==="TEXTAREA"){return}keyChar=String.fromCharCode(evt.which);for(keys in this.keyBindings){if(_.has(this.keyBindings,keys)&&keys.indexOf(keyChar)!==-1){evt.stopPropagation();evt.preventDefault();func=this.keyBindings[keys];if(!_.isFunction(func)){func=this[func]}func.call(this,evt);return}}},this))},undelegateKeyBindings:function(){this.$el.off("keypress.keybindings"+this.cid)},delegateEvents:function(events){var result=Backbone.View.prototype.delegateEvents.call(this,events);this.delegateKeyBindings();return result},undelegateEvents:function(){var result=Backbone.View.prototype.undelegateEvents.call(this);this.undelegateKeyBindings();return result}};RB.BaseCollection=Backbone.Collection.extend({fetch:function(options,context){options=_.bindCallbacks(options||{},context);return Backbone.Collection.prototype.fetch.call(this,options)},sync:function(method,model,options){options=options||{};return Backbone.sync.call(this,method,model,_.defaults({error:_.bind(function(xhr){RB.storeAPIError(xhr);if(_.isFunction(options.error)){options.error(xhr)}},this)},options))}});RB.FilteredCollection=RB.BaseCollection.extend({initialize:function(models,options){this.collection=options.collection;this.filters=options.filters;this.listenTo(this.collection,"add",this._onItemAdded);this.listenTo(this.collection,"remove",this.remove);this.listenTo(this.collection,"reset",this._rebuild);this._rebuild()},setFilters:function(filters){this.filters=filters;this._rebuild()},_onItemAdded:function(item){if(this._passesFilters(item,true)){this.add(item)}},_rebuild:function(){if(_.isEmpty(this.filters)){this.reset(this.collection.models)}else{this.reset(this.collection.filter(this._passesFilters,this))}},_passesFilters:function(item,checkEmpty){if(checkEmpty&&(!this.filters||_.isEmpty(this.filters))){return true}return _.every(this.filters,function(value,key){var attrValue=item.get(key);if(_.isString(value)){return attrValue.indexOf(value)===0}else{return attrValue===value}})}});RB.Extension=Djblets.Extension;RB.ExtensionHook=Djblets.ExtensionHook;RB.ExtensionHookPoint=Djblets.ExtensionHookPoint;RB.CommentDialogHook=RB.ExtensionHook.extend({hookPoint:new RB.ExtensionHookPoint,defaults:_.defaults({viewType:null},RB.ExtensionHook.prototype.defaults),setUpHook:function(){console.assert(this.get("viewType"),"CommentDialogHook instance does not have a "+'"viewType" attribute set.')}});RB.ReviewDialogCommentHook=RB.ExtensionHook.extend({hookPoint:new RB.ExtensionHookPoint,defaults:_.defaults({viewType:null},RB.ExtensionHook.prototype.defaults),setUpHook:function(){console.assert(this.get("viewType"),"ReviewDialogCommentHook instance does not have a "+'"viewType" attribute set.')}});RB.ReviewDialogHook=RB.ExtensionHook.extend({hookPoint:new RB.ExtensionHookPoint,defaults:_.defaults({viewType:null},RB.ExtensionHook.prototype.defaults),setUpHook:function(){console.assert(this.get("viewType"),"ReviewDialogHook instance does not have a "+'"viewType" attribute set.')}});RB.PageManager=Backbone.Model.extend({defaults:{page:null,rendered:false},initialize:function(){this.once("change:page",function(){this.trigger("beforeRender");$(document).ready(_.bind(this._renderPage,this))},this)},beforeRender:function(cb,context){var page=this.get("page");console.assert(!this.get("rendered"),"beforeRender called after page was rendered");if(page){cb.call(context,page)}else{this.once("beforeRender",function(){cb.call(context,this.get("page"))},this)}},ready:function(cb,context){var page=this.get("page");if(page&&this.get("rendered")){cb.call(context,page)}else{this.once("change:rendered",function(){cb.call(context,this.get("page"))},this)}},_renderPage:function(){this.get("page").render();this.set("rendered",true)}},{instance:null,beforeRender:function(cb,context){this.instance.beforeRender(cb,context)},ready:function(cb,context){this.instance.ready(cb,context)},setPage:function(page){this.instance.set("page",page)},getPage:function(){return this.instance.get("page")}});RB.PageManager.instance=new RB.PageManager;RB.JSONSerializers={onlyIfUnloaded:function(value,state){return state.loaded?undefined:value},onlyIfUnloadedAndValue:function(value,state){return!state.loaded&&value?value:undefined},onlyIfValue:function(value){return value||undefined},onlyIfNew:function(value,state){return state.isNew?value:undefined},textType:function(value){return value?"markdown":"plain"}};RB.BaseResource=Backbone.Model.extend({defaults:function(){return{extraData:{},links:null,loaded:false,parentObject:null}},rspNamespace:"",urlIDAttr:"id",listKey:function(){return this.rspNamespace+"s"},expandedFields:[],extraQueryArgs:{},supportsExtraData:false,attrToJsonMap:{},serializedAttrs:[],deserializedAttrs:[],serializers:{},deserializers:{},url:function(){var links=this.get("links"),baseURL,key,link,parentObject;if(links){return links.self.href}else{parentObject=this.get("parentObject");if(parentObject){links=parentObject.get("links");if(links){key=_.result(this,"listKey");link=links[key];if(link){baseURL=link.href;return this.isNew()?baseURL:baseURL+this.get(this.urlIDAttr)+"/"}}}}return null},ready:function(options,context){var parentObject=this.get("parentObject"),success,error;options=options||{};success=options.ready?_.bind(options.ready,context):undefined;error=options.error?_.bind(options.error,context):undefined;if(this.get("loaded")){if(options.ready){options.ready.call(context)}}else if(!this.isNew()){this.fetch({data:options.data,success:success,error:error})}else if(parentObject){parentObject.ready({ready:success,error:error})}else if(options.ready){options.ready.call(context)}},ensureCreated:function(options,context){options=options||{};this.ready({ready:function(){if(!this.get("loaded")){this.save({success:_.isFunction(options.success)?_.bind(options.success,context):undefined,error:_.isFunction(options.error)?_.bind(options.error,context):undefined})}else if(_.isFunction(options.success)){options.success.call(context)}}},this)},fetch:function(options,context){var parentObject,fetchObject;options=options||{};if(this.isNew()){if(_.isFunction(options.error)){options.error.call(context,"fetch cannot be used on a resource without an ID")}return}parentObject=this.get("parentObject");fetchObject=_.bind(Backbone.Model.prototype.fetch,this,_.bindCallbacks(options,context));if(parentObject){parentObject.ready({ready:fetchObject,error:options.error},this)}else{fetchObject()}},save:function(options,context){options=options||{};this.trigger("saving",options);this.ready({ready:function(){var parentObject=this.get("parentObject");if(parentObject){parentObject.ensureCreated({success:_.bind(this._saveObject,this,options,context),error:options.error},this)}else{this._saveObject(options,context)}},error:_.isFunction(options.error)?_.bind(options.error,context):undefined},this)},_saveObject:function(options,context){var url=_.result(this,"url"),files=[],readers=[],saveOptions;if(!url){if(_.isFunction(options.error)){options.error.call(context,"The object must either be loaded from the server or "+"have a parent object before it can be saved")}return}saveOptions=_.defaults({success:_.bind(function(){if(_.isFunction(options.success)){options.success.apply(context,arguments)}this.trigger("saved",options)},this),error:_.bind(function(){if(_.isFunction(options.error)){options.error.apply(context,arguments)}this.trigger("saveFailed",options)},this)},options);saveOptions.attrs=options.attrs||this.toJSON(options);if(!options.form){if(this.payloadFileKeys&&window.File){_.each(this.payloadFileKeys,function(key){var file=saveOptions.attrs[key];if(file){files.push(file)}})}}if(files.length>0){_.each(files,function(file){var reader=new FileReader,testDone=function(reader){return reader.readyState===FileReader.DONE};readers.push(reader);reader.onloadend=_.bind(function(){if(_.every(readers,testDone)){this._saveWithFiles(files,readers,saveOptions)}},this);reader.readAsArrayBuffer(file)},this)}else{Backbone.Model.prototype.save.call(this,{},saveOptions)}},_saveWithFiles:function(files,fileReaders,options){var boundary=options.boundary||"-----multipartformboundary"+(new Date).getTime(),blob=[];_.each(_.zip(this.payloadFileKeys,files,fileReaders),function(data){var key=data[0],file=data[1],reader=data[2],fileBlobLen,fileBlob,i;if(!file||!reader){return}blob.push("--"+boundary+"\r\n");blob.push('Content-Disposition: form-data; name="'+key+'"; filename="'+file.name+'"\r\n');blob.push("Content-Type: "+file.type+"\r\n");blob.push("\r\n");fileBlob=new Uint8Array(reader.result);fileBlobLen=fileBlob.length;for(i=0;i<fileBlobLen;i++){blob.push(String.fromCharCode(fileBlob[i]))}blob.push("\r\n")});_.each(options.attrs,function(value,key){if(!_.contains(this.payloadFileKeys,key)&&value!==undefined&&value!==null){blob.push("--"+boundary+"\r\n");blob.push('Content-Disposition: form-data; name="'+key+'"\r\n');blob.push("\r\n");blob.push(value+"\r\n")}},this);blob.push("--"+boundary+"--\r\n\r\n");Backbone.Model.prototype.save.call(this,{},_.extend({data:blob.join(""),processData:false,contentType:"multipart/form-data; boundary="+boundary,xhr:this._binaryXHR},options))},_binaryXHR:function(){var xhr=$.ajaxSettings.xhr();xhr.send=xhr.sendAsBinary;return xhr},destroy:function(options,context){var parentObject=this.get("parentObject"),destroyObject=_.bind(this._destroyObject,this,options,context);this.trigger("destroying",options);if(!this.isNew()&&parentObject){parentObject.ready(_.defaults({ready:destroyObject},_.bindCallbacks(options,context)))}else{destroyObject()}},_destroyObject:function(options,context){var url=_.result(this,"url");options=options||{};if(!url){if(this.isNew()){this._finishDestroy(options,context)}else if(_.isFunction(options.error)){options.error.call(context,"The object must either be loaded from the server or "+"have a parent object before it can be deleted")}return}this.ready({ready:function(){this._finishDestroy(options,context)},error:_.isFunction(options.error)?_.bind(options.error,context):undefined},this)},_finishDestroy:function(options,context){var self=this,parentObject=this.get("parentObject");Backbone.Model.prototype.destroy.call(this,_.defaults({wait:true,success:function(){self.set(_.result(self,"defaults"));self.set({id:null,parentObject:parentObject});self.trigger("destroyed",options);if(_.isFunction(options.success)){options.success.apply(context,arguments)}}},_.bindCallbacks(options,context)))},parse:function(rsp){console.assert(this.rspNamespace,"rspNamespace must be defined on the resource model");if(rsp.stat!==undefined){rsp=rsp[this.rspNamespace]}return _.defaults({extraData:rsp.extra_data,id:rsp.id,links:rsp.links,loaded:true},this.parseResourceData(rsp))},parseResourceData:function(rsp){var len=this.deserializedAttrs.length,attrs={},attrName,jsonField,value,i;for(i=0;i<len;i++){attrName=this.deserializedAttrs[i];deserializer=this.deserializers[attrName];jsonField=this.attrToJsonMap[attrName]||attrName;value=rsp[jsonField];if(deserializer){value=deserializer.call(this,value)}if(value!==undefined){attrs[attrName]=value}}return attrs},toJSON:function(){var serializerState={isNew:this.isNew(),loaded:this.get("loaded")},len=this.serializedAttrs.length,data={},attrName,jsonField,value,i;for(i=0;i<len;i++){attrName=this.serializedAttrs[i];serializer=this.serializers[attrName];value=this.get(attrName);if(serializer){value=serializer.call(this,value,serializerState)}jsonField=this.attrToJsonMap[attrName]||attrName;data[jsonField]=value}if(this.supportsExtraData){_.each(this.get("extraData"),function(value,key){data["extra_data."+key]=value},this)}return data},sync:function(method,model,options){var data,contentType,extraQueryArgs,syncOptions;options=options||{};if(method==="read"){data=options.data||{};extraQueryArgs=_.result(this,"extraQueryArgs",{});if(!_.isEmpty(extraQueryArgs)){data=_.extend({},extraQueryArgs,data)}}else{if(options.form){data=null}else if(options.attrs&&!_.isArray(options.attrs)){data=options.attrs}else{data=model.toJSON(options);if(options.attrs){data=_.pick(data,_.map(options.attrs,function(attr){return this.attrToJsonMap[attr]||attr},this))}}contentType="application/x-www-form-urlencoded"}syncOptions=_.defaults({},options,{contentType:contentType,data:data,processData:true});if(!options.form&&this.expandedFields.length>0){syncOptions.data.expand=this.expandedFields.join(",")}syncOptions.error=_.bind(function(xhr){var rsp;RB.storeAPIError(xhr);rsp=xhr.errorPayload;if(rsp&&_.has(rsp,this.rspNamespace)){this.set(this.parse(rsp))}if(_.isFunction(options.error)){options.error(xhr)}},this);return Backbone.sync.call(this,method,model,syncOptions)},validate:function(attrs){var strings=RB.BaseResource.strings,value,key;if(this.supportsExtraData&&attrs.extraData!==undefined){if(!_.isObject(attrs.extraData)){return strings.INVALID_EXTRADATA_TYPE}for(key in attrs.extraData){if(attrs.extraData.hasOwnProperty(key)){value=attrs.extraData[key];if(!_.isNull(value)&&(!_.isNumber(value)||_.isNaN(value))&&!_.isBoolean(value)&&!_.isString(value)){return strings.INVALID_EXTRADATA_VALUE_TYPE.replace("{key}",key)}}}}}},{strings:{UNSET_PARENT_OBJECT:"parentObject must be set",INVALID_EXTRADATA_TYPE:"extraData must be an object, null, or undefined",INVALID_EXTRADATA_VALUE_TYPE:"extraData.{key} must be null, a number, boolean, or string"}});RB.APIToken=RB.BaseResource.extend({defaults:function(){return _.defaults({tokenValue:null,note:null,policy:{},userName:null},RB.BaseResource.prototype.defaults())},rspNamespace:"api_token",url:function(){var url=SITE_ROOT+(this.get("localSitePrefix")||"")+"api/users/"+this.get("userName")+"/api-tokens/";if(!this.isNew()){url+=this.id+"/"}return url},toJSON:function(){return{note:this.get("note"),policy:JSON.stringify(this.get("policy"))}},parseResourceData:function(rsp){return{tokenValue:rsp.token,note:rsp.note,policy:rsp.policy}}},{defaultPolicies:{readWrite:{},readOnly:{resources:{"*":{allow:["GET","HEAD","OPTIONS"],block:["*"]}}},custom:{resources:{"*":{allow:["*"],block:[]}}}}});RB.RepositoryBranch=RB.BaseResource.extend({defaults:function(){return _.defaults({name:null,commit:null,isDefault:false},RB.BaseResource.prototype.defaults())},rspNamespace:"branches",deserializedAttrs:["id","name","commit","isDefault"],serializedAttrs:["id","name","commit","isDefault"],attrToJsonMap:{isDefault:"default"},parse:function(response){return{id:response.id,name:response.name,commit:response.commit,isDefault:response["default"]}}});RB.RepositoryCommit=RB.BaseResource.extend({defaults:function(){return _.defaults({accessible:true,authorName:null,date:null,parent:null,message:null,summary:null,reviewRequestURL:null},RB.BaseResource.prototype.defaults())},rspNamespace:"commits",deserializedAttrs:["authorName","date","id","parent","message","summary","reviewRequestURL"],serializedAttrs:["authorName","date","id","parent","message","reviewRequestURL"],attrToJsonMap:{authorName:"author_name",reviewRequestURL:"review_request_url",summary:"message"},deserializers:{date:function(date){return date?new Date(date):""},summary:function(message){return message.split("\n",1)[0]}},serializers:{date:function(date){return date.toString()}},parseResourceData:function(rsp){var data=RB.BaseResource.prototype.parseResourceData.call(this,rsp);data.accessible=rsp.date||rsp.message||rsp.author_name;return data}});RB.DraftResourceChildModelMixin={destroy:function(options,context){options=options||{};this.get("parentObject").ensureCreated({success:_.bind(_super(this).destroy,this,options,context),error:options.error},context)},ready:function(options,context){options=options||{};this.get("parentObject").ensureCreated({success:_.bind(_super(this).ready,this,options,context),error:options.error},context)}};RB.DraftResourceModelMixin={ready:function(options,context){var self=this,sup=_super(this);if(!this.get("loaded")&&this.isNew()&&this._needDraft===undefined){this._needDraft=true}if(this._needDraft){sup.ready.call(this,_.defaults({ready:function(){self._retrieveDraft(options,context)}},options),context)}else{sup.ready.call(this,options,context)}},destroy:function(options,context){options=_.bindCallbacks(options||{});this.ready(_.defaults({ready:function(){_super(this).destroy.call(this,_.defaults({success:function(){this._needDraft=true;if(_.isFunction(options.success)){options.success.apply(context,arguments)}}},options),this)}},options),this)},url:function(){var parentObject,links,linkName;if(this._needDraft){parentObject=this.get("parentObject");linkName=_.result(this,"listKey");links=parentObject.get("links");return links[linkName].href+"draft/?"+$.now()}else{return _super(this).url.call(this)}},_retrieveDraft:function(options,context){var self=this,extraQueryArgs,data;if(!RB.UserSession.instance.get("authenticated")){if(options.error){options.error.call(context,{errorText:gettext("You must be logged in to retrieve the draft.")})}return}options=options||{};data=options.data||{};extraQueryArgs=_.result(this,"extraQueryArgs",{});if(!_.isEmpty(extraQueryArgs)){data=_.extend({},extraQueryArgs,data)}Backbone.Model.prototype.fetch.call(this,{data:data,processData:true,success:function(){self._needDraft=false;if(options&&_.isFunction(options.ready)){options.ready.call(context)}},error:function(model,xhr){if(xhr.status===404){self._needDraft=false;options.ready.call(context)}else if(options&&_.isFunction(options.error)){options.error.call(context,xhr,xhr.status)}}})}};RB.DraftReviewRequest=RB.BaseResource.extend(_.defaults({defaults:function(){return _.defaults({branch:null,bugsClosed:null,changeDescription:null,chnageDescriptionRichText:false,dependsOn:[],description:null,descriptionRichText:false,"public":null,summary:null,targetGroups:[],targetPeople:[],testingDone:null,testingDoneRichText:false},RB.BaseResource.prototype.defaults())},rspNamespace:"draft",listKey:"draft",supportsExtraData:true,expandedFields:["depends_on","target_people","target_groups"],extraQueryArgs:{"force-text-type":"html","include-text-types":"raw"},attrToJsonMap:{bugsClosed:"bugs_closed",changeDescription:"changedescription",changeDescriptionRichText:"changedescription_text_type",dependsOn:"depends_on",descriptionRichText:"description_text_type",targetGroups:"target_groups",targetPeople:"target_people",testingDone:"testing_done",testingDoneRichText:"testing_done_text_type"},deserializedAttrs:["branch","bugsClosed","changeDescription","dependsOn","description","public","summary","targetGroups","targetPeople","testingDone"],url:function(){return this.get("parentObject").get("links").draft.href},createFileAttachment:function(attributes){return new RB.DraftFileAttachment(_.defaults({parentObject:this},attributes))},publish:function(options,context){options=options||{};this.ready({ready:function(){var validationError=this.validate(this.attributes,{publishing:true});if(validationError){if(_.isFunction(options.error)){options.error.call(context,this,{errorText:validationError})}}else{this.save(_.defaults({data:{"public":1,trivial:options.trivial?1:0}},options),context)}},error:_.isFunction(options.error)?_.bind(options.error,context):undefined},this)},validate:function(attrs,options){var strings=RB.DraftReviewRequest.strings;if(options.publishing){if(attrs.targetGroups.length===0&&attrs.targetPeople.length===0){return strings.REVIEWERS_REQUIRED}if($.trim(attrs.summary)===""){return strings.SUMMARY_REQUIRED}if($.trim(attrs.description)===""){return strings.DESCRIPTION_REQUIRED}}return _super(this).validate.call(this,attrs,options)},parseResourceData:function(rsp){var rawTextFields=rsp.raw_text_fields||rsp,data=RB.BaseResource.prototype.parseResourceData.call(this,rsp);data.changeDescriptionRichText=rawTextFields.changedescription_text_type==="markdown";data.descriptionRichText=rawTextFields.description_text_type==="markdown";data.testingDoneRichText=rawTextFields.testing_done_text_type==="markdown";return data}},RB.DraftResourceModelMixin),{strings:{DESCRIPTION_REQUIRED:gettext("The draft must have a description."),REVIEWERS_REQUIRED:gettext("There must be at least one reviewer before this review request can be published."),SUMMARY_REQUIRED:gettext("The draft must have a summary.")}});RB.Review=RB.BaseResource.extend({defaults:function(){return _.defaults({forceTextType:null,shipIt:false,"public":false,bodyTop:null,bodyTopRichText:false,bodyBottom:null,bodyBottomRichText:false,draftReply:null,includeTextTypes:null,markdownTextFields:{},rawTextFields:{},timestamp:null},RB.BaseResource.prototype.defaults())},rspNamespace:"review",attrToJsonMap:{bodyBottom:"body_bottom",bodyBottomRichText:"body_bottom_text_type",bodyTop:"body_top",bodyTopRichText:"body_top_text_type",forceTextType:"force_text_type",includeTextTypes:"include_text_types",shipIt:"ship_it"},serializedAttrs:["forceTextType","includeTextTypes","shipIt","bodyTop","bodyTopRichText","bodyBottom","bodyBottomRichText","public"],deserializedAttrs:["shipIt","bodyTop","bodyBottom","public","timestamp"],serializers:{forceTextType:RB.JSONSerializers.onlyIfValue,includeTextTypes:RB.JSONSerializers.onlyIfValue,bodyTopRichText:RB.JSONSerializers.textType,bodyBottomRichText:RB.JSONSerializers.textType,"public":function(value){return value?1:undefined}},supportsExtraData:true,parseResourceData:function(rsp){var rawTextFields=rsp.raw_text_fields||rsp,data=RB.BaseResource.prototype.parseResourceData.call(this,rsp);data.bodyTopRichText=rawTextFields.body_top_text_type==="markdown";data.bodyBottomRichText=rawTextFields.body_bottom_text_type==="markdown";if(rsp.raw_text_fields){data.rawTextFields={bodyBottom:rsp.raw_text_fields.body_bottom,bodyTop:rsp.raw_text_fields.body_top}}if(rsp.markdown_text_fields){data.markdownTextFields={bodyBottom:rsp.markdown_text_fields.body_bottom,bodyTop:rsp.markdown_text_fields.body_top}}return data},createDiffComment:function(id,fileDiffID,interFileDiffID,beginLineNum,endLineNum){
return new RB.DiffComment({parentObject:this,id:id,fileDiffID:fileDiffID,interFileDiffID:interFileDiffID,beginLineNum:beginLineNum,endLineNum:endLineNum})},createScreenshotComment:function(id,screenshot_id,x,y,width,height){return new RB.ScreenshotComment({parentObject:this,id:id,screenshotID:screenshot_id,x:x,y:y,width:width,height:height})},createFileAttachmentComment:function(id,fileAttachmentID,diffAgainstFileAttachmentID){return new RB.FileAttachmentComment({parentObject:this,id:id,fileAttachmentID:fileAttachmentID,diffAgainstFileAttachmentID:diffAgainstFileAttachmentID})},createReply:function(){var draftReply=this.get("draftReply");if(draftReply===null){draftReply=new RB.ReviewReply({parentObject:this});this.set("draftReply",draftReply);draftReply.once("published",function(){var reviewRequest=this.get("parentObject");reviewRequest.markUpdated(draftReply.get("timestamp"));this.set("draftReply",null)},this)}return draftReply}});RB.DraftReview=RB.Review.extend(_.extend({publish:function(options,context){options=options||{};this.trigger("publishing");this.ready({ready:function(){this.set("public",true);this.save({attrs:options.attrs,success:function(){this.trigger("published");if(_.isFunction(options.success)){options.success.call(context)}},error:function(model,xhr){model.trigger("publishError",xhr.errorText);if(_.isFunction(options.error)){options.error.call(context,model,xhr)}}},this)},error:error},this)}},RB.DraftResourceModelMixin));RB.BaseComment=RB.BaseResource.extend({defaults:function(){return _.defaults({forceTextType:null,includeTextTypes:null,issueOpened:null,issueStatus:null,markdownTextFields:{},rawTextFields:{},richText:null,text:""},RB.BaseResource.prototype.defaults())},extraQueryArgs:function(){var textTypes="raw";if(RB.UserSession.instance.get("defaultUseRichText")){textTypes+=",markdown"}return{"force-text-type":"html","include-text-types":textTypes}},supportsExtraData:true,attrToJsonMap:{forceTextType:"force_text_type",includeTextTypes:"include_text_types",issueOpened:"issue_opened",issueStatus:"issue_status",richText:"text_type"},serializedAttrs:["forceTextType","includeTextTypes","issueOpened","issueStatus","richText","text"],deserializedAttrs:["issueOpened","issueStatus","text","html"],serializers:{forceTextType:RB.JSONSerializers.onlyIfValue,includeTextTypes:RB.JSONSerializers.onlyIfValue,richText:RB.JSONSerializers.textType,issueStatus:function(value){var parentObject;if(this.get("loaded")){parentObject=this.get("parentObject");if(parentObject.get("public")){return value}}return undefined}},destroyIfEmpty:function(options,context){if(!this.get("text")){this.destroy(options,context)}},parseResourceData:function(rsp){var rawTextFields=rsp.raw_text_fields||rsp,data=RB.BaseResource.prototype.parseResourceData.call(this,rsp);data.richText=rawTextFields.text_type==="markdown";if(rsp.raw_text_fields){data.rawTextFields={text:rsp.raw_text_fields.text}}if(rsp.markdown_text_fields){data.markdownTextFields={text:rsp.markdown_text_fields.text}}if(rsp.html_text_fields){data.html=rsp.html_text_fields.text}return data},validate:function(attrs){if(_.has(attrs,"parentObject")&&!attrs.parentObject){return RB.BaseResource.strings.UNSET_PARENT_OBJECT}if(attrs.issueStatus&&attrs.issueStatus!==RB.BaseComment.STATE_DROPPED&&attrs.issueStatus!==RB.BaseComment.STATE_OPEN&&attrs.issueStatus!==RB.BaseComment.STATE_RESOLVED){return RB.BaseComment.strings.INVALID_ISSUE_STATUS}return RB.BaseResource.prototype.validate.apply(this,arguments)}},{STATE_DROPPED:"dropped",STATE_OPEN:"open",STATE_RESOLVED:"resolved",strings:{INVALID_ISSUE_STATUS:"issueStatus must be one of STATE_DROPPED, "+"STATE_OPEN, or STATE_RESOLVED"}});RB.BaseCommentReply=RB.BaseResource.extend({defaults:function(){return _.defaults({forceTextType:null,includeTextTypes:null,rawTextFields:{},replyToID:null,richText:false,text:""},RB.BaseResource.prototype.defaults())},attrToJsonMap:{forceTextType:"force_text_type",includeTextTypes:"include_text_types",replyToID:"reply_to_id",richText:"text_type"},serializedAttrs:["forceTextType","includeTextTypes","replyToID","richText","text"],deserializedAttrs:["text"],serializers:{forceTextType:RB.JSONSerializers.onlyIfValue,includeTextTypes:RB.JSONSerializers.onlyIfValue,replyToID:RB.JSONSerializers.onlyIfUnloaded,richText:RB.JSONSerializers.textType},destroyIfEmpty:function(options,context){if(!this.get("text")){this.destroy(options,context)}},parseResourceData:function(rsp){var rawTextFields=rsp.raw_text_fields||rsp,data=RB.BaseResource.prototype.parseResourceData.call(this,rsp);data.rawTextFields=rsp.raw_text_fields||{};data.richText=rawTextFields.text_type==="markdown";return data},validate:function(attrs){if(_.has(attrs,"parentObject")&&!attrs.parentObject){return RB.BaseResource.strings.UNSET_PARENT_OBJECT}}});RB.DefaultReviewer=RB.BaseResource.extend({defaults:function(){return _.defaults({name:null,fileRegex:null},RB.BaseResource.prototype.defaults())},rspNamespace:"default_reviewer",attrToJsonMap:{fileRegex:"file_regex"},serializedAttrs:["fileRegex","name"],deserializedAttrs:["fileRegex","name"],url:function(){var url=SITE_ROOT+(this.get("localSitePrefix")||"")+"api/default-reviewers/";if(!this.isNew()){url+=this.id+"/"}return url}});(function(){var parentProto=RB.BaseComment.prototype;RB.DiffComment=RB.BaseComment.extend({defaults:function(){return _.defaults({beginLineNum:0,endLineNum:0,fileDiff:null,fileDiffID:null,interFileDiff:null,interFileDiffID:null},parentProto.defaults())},rspNamespace:"diff_comment",expandedFields:["filediff","interfilediff"],attrToJsonMap:_.defaults({fileDiffID:"filediff_id",beginLineNum:"first_line",interFileDiffID:"interfilediff_id",numLines:"num_lines"},parentProto.attrToJsonMap),serializedAttrs:["beginLineNum","numLines","fileDiffID","interFileDiffID"].concat(parentProto.serializedAttrs),deserializedAttrs:["beginLineNum","endLineNum"].concat(parentProto.deserializedAttrs),serializers:_.defaults({fileDiffID:RB.JSONSerializers.onlyIfUnloaded,interFileDiffID:RB.JSONSerializers.onlyIfUnloadedAndValue,numLines:function(){return this.getNumLines()}},parentProto.serializers),getNumLines:function(){return this.get("endLineNum")-this.get("beginLineNum")+1},parseResourceData:function(rsp){var result=parentProto.parseResourceData.call(this,rsp);result.endLineNum=rsp.num_lines+result.beginLineNum-1;result.fileDiff=new RB.FileDiff(rsp.filediff,{parse:true});if(rsp.interfilediff){result.interFileDiff=new RB.FileDiff(rsp.interfilediff,{parse:true})}return result},validate:function(attrs,options){var strings=RB.DiffComment.strings,hasBeginLineNum,hasEndLineNum;if(this.isNew()&&_.has(attrs,"fileDiffID")&&!attrs.fileDiffID){return strings.INVALID_FILEDIFF_ID}hasBeginLineNum=_.has(attrs,"beginLineNum");if(hasBeginLineNum&&attrs.beginLineNum<0){return strings.BEGINLINENUM_GTE_0}hasEndLineNum=_.has(attrs,"endLineNum");if(hasEndLineNum&&attrs.endLineNum<0){return strings.ENDLINENUM_GTE_0}if(hasBeginLineNum&&hasEndLineNum&&attrs.beginLineNum>attrs.endLineNum){return strings.BEGINLINENUM_LTE_ENDLINENUM}return parentProto.validate.call(this,attrs,options)}},{strings:{INVALID_FILEDIFF_ID:"fileDiffID must be a valid ID",BEGINLINENUM_GTE_0:"beginLineNum must be >= 0",ENDLINENUM_GTE_0:"endLineNum must be >= 0",BEGINLINENUM_LTE_ENDLINENUM:"beginLineNum must be <= endLineNum"}})})();RB.DiffCommentReply=RB.BaseCommentReply.extend({rspNamespace:"diff_comment"});(function(){var parentProto=RB.BaseResource.prototype;RB.Diff=RB.BaseResource.extend({defaults:function(){return _.defaults({diff:null,parentDiff:null,basedir:null},parentProto.defaults())},rspNamespace:"diff",attrToJsonMap:{diff:"path",parentDiff:"parent_diff_path"},serializedAttrs:["basedir","diff","parentDiff"].concat(parentProto.serializedAttrs),payloadFileKeys:["path","parent_diff_path"],listKey:"diffs",getErrorString:function(rsp){if(rsp.err.code===RB.APIErrors.REPO_FILE_NOT_FOUND){return interpolate(gettext('The file "%(file)s" (revision %(revision)s) was not found in the repository'),{file:rsp.file,revision:rsp.revision},true)}return rsp.err.msg}})})();RB.FileAttachment=RB.BaseResource.extend({defaults:function(){return _.defaults({attachmentHistoryID:null,caption:null,downloadURL:null,file:null,filename:null,reviewURL:null,revision:null,thumbnailHTML:null},RB.BaseResource.prototype.defaults())},rspNamespace:"file_attachment",payloadFileKeys:["path"],attrToJsonMap:{attachmentHistoryID:"attachment_history_id",downloadURL:"url",file:"path",reviewURL:"review_url",thumbnailHTML:"thumbnail"},serializedAttrs:["attachmentHistoryID","caption","file"],deserializedAttrs:["attachmentHistoryID","caption","downloadURL","filename","reviewURL","revision","thumbnailHTML"],serializers:{attachmentHistoryID:RB.JSONSerializers.onlyIfNew,file:RB.JSONSerializers.onlyIfNew}});(function(){var parentProto=RB.BaseComment.prototype;RB.FileAttachmentComment=RB.BaseComment.extend({defaults:function(){return _.defaults({diffAgainstFileAttachmentID:null,diffAgainstFileAttachment:null,fileAttachmentID:null,fileAttachment:null,linkText:null,reviewURL:null,thumbnailHTML:null},parentProto.defaults())},rspNamespace:"file_attachment_comment",expandedFields:["diff_against_file_attachment","file_attachment"],attrToJsonMap:_.defaults({diffAgainstFileAttachmentID:"diff_against_file_attachment_id",fileAttachmentID:"file_attachment_id",linkText:"link_text",reviewURL:"review_url",thumbnailHTML:"thumbnail_html"},parentProto.attrToJsonMap),serializedAttrs:["diffAgainstFileAttachmentID","fileAttachmentID"].concat(parentProto.serializedAttrs),deserializedAttrs:["linkText","thumbnailHTML","reviewURL"].concat(parentProto.deserializedAttrs),serializers:_.defaults({fileAttachmentID:RB.JSONSerializers.onlyIfUnloaded,diffAgainstFileAttachmentID:RB.JSONSerializers.onlyIfUnloadedAndValue},parentProto.serializers),parseResourceData:function(rsp){var result=parentProto.parseResourceData.call(this,rsp);result.fileAttachment=new RB.FileAttachment(rsp.file_attachment,{parse:true});result.fileAttachmentID=result.fileAttachment.id;if(rsp.diff_against_file_attachment){result.diffAgainstFileAttachment=new RB.FileAttachment(rsp.diff_against_file_attachment,{parse:true});result.diffAgainstFileAttachmentID=result.diffAgainstFileAttachment.id}return result},validate:function(attrs,options){var strings=RB.FileAttachmentComment.strings;if(_.has(attrs,"fileAttachmentID")&&!attrs.fileAttachmentID){return strings.INVALID_FILE_ATTACHMENT_ID}return _super(this).validate.call(this,attrs,options)}},{strings:{INVALID_FILE_ATTACHMENT_ID:"fileAttachmentID must be a valid ID"}})})();RB.FileAttachmentCommentReply=RB.BaseCommentReply.extend({rspNamespace:"file_attachment_comment"});RB.FileDiff=RB.BaseResource.extend({defaults:function(){return _.defaults({destFilename:null,sourceFilename:null,sourceRevision:null},RB.BaseResource.prototype.defaults())},rspNamespace:"filediff",parseResourceData:function(rsp){return{destFilename:rsp.dest_file,sourceFilename:rsp.source_file,sourceRevision:rsp.source_revision}}});RB.DraftFileAttachment=RB.FileAttachment.extend(_.defaults({rspNamespace:"draft_file_attachment"},RB.DraftResourceChildModelMixin));RB.Repository=RB.BaseResource.extend({defaults:function(){return _.defaults({filesOnly:false,localSitePrefix:null,name:null,requiresBasedir:false,requiresChangeNumber:false,scmtoolName:null,supportsPostCommit:false},RB.BaseResource.prototype.defaults())},rspNamespace:"repository",initialize:function(){RB.BaseResource.prototype.initialize.apply(this,arguments);this.branches=new RB.RepositoryBranches;this.branches.url=_.result(this,"url")+"branches/"},getCommits:function(options){return new RB.RepositoryCommits([],{urlBase:_.result(this,"url")+"commits/",start:options.start,branch:options.branch})},url:function(){var url=SITE_ROOT+(this.get("localSitePrefix")||"")+"api/repositories/";if(!this.isNew()){url+=this.id+"/"}return url}});(function(){var GroupMember=RB.BaseResource.extend({defaults:function(){return _.defaults({username:null,added:false,loaded:true},RB.BaseResource.prototype.defaults())},serializedAttrs:["username"],url:function(){var url=this.get("baseURL");if(this.get("added")){url+=this.get("username")+"/"}return url},isNew:function(){return!this.get("added")},parse:function(){}});RB.ReviewGroup=RB.BaseResource.extend({defaults:_.defaults({name:null},RB.BaseResource.prototype.defaults),rspNamespace:"group",url:function(){var url=SITE_ROOT+(this.get("localSitePrefix")||"")+"api/groups/";if(!this.isNew()){url+=this.get("name")+"/"}return url},setStarred:function(starred,options,context){var watched=RB.UserSession.instance.watchedGroups;if(starred){watched.addImmediately(this,options,context)}else{watched.removeImmediately(this,options,context)}},addUser:function(username,options,context){var url=this.url()+"users/",member;if(url&&!this.isNew()){member=new GroupMember({username:username,baseURL:url});member.save(options,context)}else if(options&&_.isFunction(options.error)){options.error.call({errorText:"Unable to add to the group."})}},removeUser:function(username,options,context){var url=this.url()+"users/",member;if(url&&!this.isNew()){member=new GroupMember({username:username,baseURL:url,added:true});member.destroy(options,context)}else if(options&&_.isFunction(options.error)){options.error.call({errorText:"Unable to remove from the group."})}}})})();RB.ReviewReply=RB.BaseResource.extend({defaults:function(){return _.defaults({forceTextType:null,includeTextTypes:null,rawTextFields:{},review:null,"public":false,bodyTop:null,bodyTopRichText:false,bodyBottom:null,bodyBottomRichText:false,timestamp:null},RB.BaseResource.prototype.defaults())},rspNamespace:"reply",listKey:"replies",extraQueryArgs:{"force-text-type":"html","include-text-types":"raw"},attrToJsonMap:{bodyBottom:"body_bottom",bodyBottomRichText:"body_bottom_text_type",bodyTop:"body_top",bodyTopRichText:"body_top_text_type",forceTextType:"force_text_type",includeTextTypes:"include_text_types"},serializedAttrs:["forceTextType","includeTextTypes","bodyTop","bodyTopRichText","bodyBottom","bodyBottomRichText","public"],deserializedAttrs:["bodyTop","bodyBottom","public","timestamp"],serializers:{forceTextType:RB.JSONSerializers.onlyIfValue,includeTextTypes:RB.JSONSerializers.onlyIfValue,bodyTopRichText:RB.JSONSerializers.textType,bodyBottomRichText:RB.JSONSerializers.textType,"public":function(value){return value?true:undefined}},COMMENT_LINK_NAMES:["diff_comments","file_attachment_comments","screenshot_comments"],parseResourceData:function(rsp){var rawTextFields=rsp.raw_text_fields||rsp,data=RB.BaseResource.prototype.parseResourceData.call(this,rsp);data.bodyTopRichText=rawTextFields.body_top_text_type==="markdown";data.bodyBottomRichText=rawTextFields.body_bottom_text_type==="markdown";data.rawTextFields=rsp.raw_text_fields||{};return data},publish:function(options,context){options=options||{};this.trigger("publishing");this.ready({ready:function(){this.set("public",true);this.save({data:{"public":1,trivial:options.trivial?1:0},success:function(){this.trigger("published");if(_.isFunction(options.success)){options.success.call(context)}},error:function(model,xhr){model.trigger("publishError",xhr.errorText);if(_.isFunction(options.error)){options.error.call(context,model,xhr)}}},this)}},this)},discardIfEmpty:function(options,context){options=_.bindCallbacks(options||{},context);options.success=options.success||function(){};this.ready({ready:function(){if(this.isNew()||this.get("bodyTop")||this.get("bodyBottom")){options.success(false);return}this._checkCommentsLink(0,options,context)},error:options.error},this)},_checkCommentsLink:function(linkNameIndex,options,context){var self=this,linkName=this.COMMENT_LINK_NAMES[linkNameIndex],url=this.get("links")[linkName].href;RB.apiCall({type:"GET",url:url,success:function(rsp){if(rsp[linkName].length>0){if(options.success){options.success(false)}}else if(linkNameIndex<self.COMMENT_LINK_NAMES.length-1){self._checkCommentsLink(linkNameIndex+1,options,context)}else{self.destroy(_.defaults({success:function(){options.success(true)}},options),context)}},error:options.error})}});_.extend(RB.ReviewReply.prototype,RB.DraftResourceModelMixin);RB.ReviewRequest=RB.BaseResource.extend({defaults:function(){return _.defaults({approved:false,approvalFailure:null,branch:null,bugTrackerURL:null,bugsClosed:null,commitID:null,closeDescription:null,closeDescriptionRichText:false,dependsOn:[],description:null,descriptionRichText:false,draftReview:null,lastUpdated:null,localSitePrefix:null,"public":null,repository:null,reviewURL:null,state:null,summary:null,targetGroups:[],targetPeople:[],testingDone:null,testingDoneRichText:false},RB.BaseResource.prototype.defaults())},rspNamespace:"review_request",extraQueryArgs:{"force-text-type":"html","include-text-types":"raw"},attrToJsonMap:{approvalFailure:"approval_failure",bugsClosed:"bugs_closed",closeDescription:"close_description",closeDescriptionRichText:"close_description_text_type",dependsOn:"depends_on",descriptionRichText:"description_text_type",lastUpdated:"last_updated",reviewURL:"url",targetGroups:"target_groups",targetPeople:"target_people",testingDone:"testing_done",testingDoneRichText:"testing_done_text_type"},deserializedAttrs:["approved","approvalFailure","branch","bugsClosed","closeDescription","dependsOn","description","lastUpdated","public","reviewURL","summary","targetGroups","targetPeople","testingDone"],initialize:function(attrs,options){options=options||{};RB.BaseResource.prototype.initialize.call(this,attrs,options);this.reviews=new Backbone.Collection([],{model:RB.Review});this.draft=new RB.DraftReviewRequest(_.defaults({parentObject:this,branch:this.get("branch"),bugsClosed:this.get("bugsClosed"),dependsOn:this.get("dependsOn"),description:this.get("description"),descriptionRichText:this.get("descriptionRichText"),summary:this.get("summary"),targetGroups:this.get("targetGroups"),targetPeople:this.get("targetPeople"),testingDone:this.get("testingDone"),testingDoneRichText:this.get("testingDoneRichText")},options.extraDraftAttrs))},url:function(){var url=SITE_ROOT+(this.get("localSitePrefix")||"")+"api/review-requests/";if(!this.isNew()){url+=this.id+"/"}return url},createFromCommit:function(options,context){console.assert(options.commitID);console.assert(this.isNew());this.set("commitID",options.commitID);this.save(_.extend({createFromCommit:true},options),context)},createDiff:function(){return new RB.Diff({parentObject:this})},createReview:function(reviewID){var review;if(reviewID===undefined){review=this.get("draftReview");if(review===null){review=new RB.DraftReview({parentObject:this});this.set("draftReview",review)}return review}else{review=this.reviews.get(reviewID);if(!review){review=new RB.Review({parentObject:this,id:reviewID});this.reviews.add(review)}}return review},createScreenshot:function(screenshotID){return new RB.Screenshot({parentObject:this,id:screenshotID})},createFileAttachment:function(attributes){return new RB.FileAttachment(_.defaults({parentObject:this},attributes))},setStarred:function(starred,options,context){var watched=RB.UserSession.instance.watchedReviewRequests;if(starred){watched.addImmediately(this,options,context)}else{watched.removeImmediately(this,options,context)}},close:function(options,context){var data={},changingState,saveOptions;console.assert(options);if(options.type===RB.ReviewRequest.CLOSE_DISCARDED){data.status="discarded"}else if(options.type===RB.ReviewRequest.CLOSE_SUBMITTED){data.status="submitted"}else{if(_.isFunction(options.error)){options.error.call(this,{errorText:"Invalid close type"})}return}if(options.description!==undefined){data.close_description=options.description}if(options.richText!==undefined){data.close_description_text_type=options.richText?"markdown":"plain"}if(options.postData!==undefined){_.extend(data,options.postData)}changingState=options.type!==this.get("state");saveOptions=_.defaults({data:data,success:_.bind(function(){if(changingState){this.trigger("closed")}this.markUpdated(this.get("lastUpdated"));if(_.isFunction(options.success)){options.success.call(context)}},this)},options);delete saveOptions.type;delete saveOptions.description;this.save(saveOptions,context)},reopen:function(options,context){options=options||{};this.save(_.defaults({data:{status:"pending"},success:_.bind(function(){this.trigger("reopened");this.markUpdated(this.get("lastUpdated"));if(_.isFunction(options.success)){options.success.call(context)}},this)},options),context)},markUpdated:function(timestamp){this._lastUpdateTimestamp=timestamp},beginCheckForUpdates:function(type,lastUpdateTimestamp){this._checkUpdatesType=type;this._lastUpdateTimestamp=lastUpdateTimestamp;this.ready({ready:function(){setTimeout(_.bind(this._checkForUpdates,this),RB.ReviewRequest.CHECK_UPDATES_MSECS)}},this)},_checkForUpdates:function(){RB.apiCall({type:"GET",prefix:this.get("sitePrefix"),noActivityIndicator:true,url:this.get("links").last_update.href,success:_.bind(function(rsp){var lastUpdate=rsp.last_update;if((this._checkUpdatesType===undefined||this._checkUpdatesType===lastUpdate.type)&&this._lastUpdateTimestamp!==lastUpdate.timestamp){this.trigger("updated",lastUpdate)}this._lastUpdateTimestamp=lastUpdate.timestamp;setTimeout(_.bind(this._checkForUpdates,this),RB.ReviewRequest.CHECK_UPDATES_MSECS)},this)})},toJSON:function(options){var commitID=this.get("commitID"),repository=this.get("repository"),result={};options=options||{};if(this.isNew()){if(commitID){result.commit_id=commitID;if(options.createFromCommit){result.create_from_commit_id=true}}if(repository){result.repository=repository}return result}else{return _super(this).toJSON.apply(this,arguments)}},parseResourceData:function(rsp){var state={pending:RB.ReviewRequest.PENDING,discarded:RB.ReviewRequest.CLOSE_DISCARDED,submitted:RB.ReviewRequest.CLOSE_SUBMITTED}[rsp.status],rawTextFields=rsp.raw_text_fields||rsp,data=RB.BaseResource.prototype.parseResourceData.call(this,rsp);data.state=state;data.closeDescriptionRichText=rawTextFields.close_description_text_type==="markdown";data.descriptionRichText=rawTextFields.description_text_type==="markdown";data.testingDoneRichText=rawTextFields.testing_done_text_type==="markdown";return data}},{CHECK_UPDATES_MSECS:5*60*1e3,CLOSE_DISCARDED:1,CLOSE_SUBMITTED:2,PENDING:3,VISIBILITY_VISIBLE:1,VISIBILITY_ARCHIVED:2,VISIBILITY_MUTED:3});RB.Screenshot=RB.BaseResource.extend({defaults:function(){return _.defaults({caption:null,filename:null,reviewURL:null},RB.BaseResource.prototype.defaults())},rspNamespace:"screenshot",attrToJsonMap:{reviewURL:"review_url"},serializedAttrs:["caption"],deserializedAttrs:["caption","filename","reviewURL"],getDisplayName:function(){return this.get("caption")||this.get("filename")}});(function(){var parentProto=RB.BaseComment.prototype;RB.ScreenshotComment=RB.BaseComment.extend({defaults:function(){return _.defaults({x:null,y:null,width:null,height:null,screenshotID:null,screenshot:null,thumbnailURL:null},parentProto.defaults())},rspNamespace:"screenshot_comment",expandedFields:["screenshot"],attrToJsonMap:_.defaults({width:"w",height:"h",thumbnailURL:"thumbnail_url",screenshotID:"screenshot_id"},parentProto.attrToJsonMap),serializedAttrs:["x","y","width","height","screenshotID"].concat(parentProto.serializedAttrs),deserializedAttrs:["x","y","width","height","thumbnailURL"].concat(parentProto.deserializedAttrs),serializers:_.defaults({screenshotID:RB.JSONSerializers.onlyIfUnloaded},parentProto.serializers),parseResourceData:function(rsp){var result=parentProto.parseResourceData.call(this,rsp);result.screenshot=new RB.Screenshot(rsp.screenshot,{parse:true});result.screenshotID=result.screenshot.id;return result},validate:function(attrs,options){var strings=RB.ScreenshotComment.strings;if(_.has(attrs,"screenshotID")&&!attrs.screenshotID){return strings.INVALID_SCREENSHOT_ID}if(_.has(attrs,"x")&&attrs.x<0){return strings.INVALID_X}if(_.has(attrs,"y")&&attrs.y<0){return strings.INVALID_Y}if(_.has(attrs,"width")&&attrs.width<=0){return strings.INVALID_WIDTH}if(_.has(attrs,"height")&&attrs.height<=0){return strings.INVALID_HEIGHT}return parentProto.validate.call(this,attrs,options)}},{strings:{INVALID_SCREENSHOT_ID:"screenshotID must be a valid ID",INVALID_X:"x must be >= 0",INVALID_Y:"y must be >= 0",INVALID_WIDTH:"width must be > 0",INVALID_HEIGHT:"height must be > 0"}})})();RB.ScreenshotCommentReply=RB.BaseCommentReply.extend({rspNamespace:"screenshot_comment"});(function(){var parentProto=RB.Diff.prototype;RB.ValidateDiffModel=RB.Diff.extend({defaults:function(){return _.defaults({repository:null,localSitePrefix:""},RB.Diff.prototype.defaults())},serializedAttrs:["repository"].concat(parentProto.serializedAttrs),url:function(){return SITE_ROOT+this.get("localSitePrefix")+"api/validation/diffs/"},parse:function(){}})})();RB.ResourceCollection=RB.BaseCollection.extend({initialize:function(models,options){this.parentResource=options.parentResource;this.extraQueryData=options.extraQueryData;this.maxResults=options.maxResults;this.hasPrev=false;this.hasNext=false;this.currentPage=0;this.totalResults=undefined;this._fetchURL=null;this._links=null},url:function(){var links,listKey,link;if(this._fetchURL){return this._fetchURL}if(this.parentResource){links=this.parentResource.get("links");listKey=_.result(this.model.prototype,"listKey");link=links[listKey];return link?link.href:null}return null},parse:function(rsp,options){var listKey=_.result(this.model.prototype,"listKey");options=options||{};this._links=rsp.links||null;this.totalResults=rsp.total_results;if(options.fetchingAll){this.hasPrev=false;this.hasNext=false;this.currentPage=0}else{this.totalResults=rsp.total_results;this.hasPrev=this._links!==null&&this._links.prev!==undefined;this.hasNext=this._links!==null&&this._links.next!==undefined;this.currentPage=options.page}return rsp[listKey]},fetch:function(options,context){var expandedFields=this.model.prototype.expandedFields,data;options=options||{};data=_.extend({},options.data);if(options.start!==undefined){data.start=options.start}if(!this.extraQueryData||this.extraQueryData["max-results"]===undefined){if(options.maxResults!==undefined){data["max-results"]=options.maxResults}else if(this.maxResults){data["max-results"]=this.maxResults}}if(options.reset===undefined){options.reset=true}options.remove=options.reset;if(expandedFields.length>0){data.expand=expandedFields.join(",")}if(this.extraQueryData){data=_.defaults(data,this.extraQueryData)}options.data=data;if(this.parentResource){this.parentResource.ready({ready:function(){RB.BaseCollection.prototype.fetch.call(this,options,context)},error:_.isFunction(options.error)?_.bind(options.error,context):undefined},this);return true}else{return RB.BaseCollection.prototype.fetch.call(this,options,context)}},fetchPrev:function(options,context){options=options||{};if(!this.hasPrev){return false}this._fetchURL=this._links.prev.href;return this.fetch(_.defaults({page:this.currentPage-1},options),context)},fetchNext:function(options,context){options=options||{};if(!this.hasNext&&options.enforceHasNext!==false){return false}this._fetchURL=this._links.next.href;return this.fetch(_.defaults({page:this.currentPage+1},options),context)},fetchAll:function(options,context){var fetchOptions;options=_.bindCallbacks(options||{},context);fetchOptions=_.defaults({reset:false,fetchingAll:true,enforceHasNext:false,maxResults:50,success:function(){if(this._links.next){this._fetchURL=this._links.next.href;this.fetchNext(fetchOptions,this)}else if(_.isFunction(options.success)){options.success(this,this.models,options)}}},options);this._fetchURL=null;this.reset();return this.fetch(fetchOptions,this)},_prepareModel:function(attrs,options){var model=RB.BaseCollection.prototype._prepareModel.call(this,attrs,options);model.set("parentObject",this.parentResource);return model}});RB.RepositoryBranches=RB.BaseCollection.extend({model:RB.RepositoryBranch,parse:function(response){return response.branches}});RB.RepositoryCommits=RB.BaseCollection.extend({model:RB.RepositoryCommit,initialize:function(models,options){Backbone.Collection.prototype.initialize.call(this,models,options);this.options=options;this.busy=false;this.complete=false},parse:function(response){return response.commits},url:function(){var args=[];if(this.options.start!==undefined){args.push("start="+encodeURIComponent(this.options.start))}if(this.options.branch!==undefined){args.push("branch="+encodeURIComponent(this.options.branch))}return this.options.urlBase+"?"+args.join("&")},fetchNext:function(){var nextStart;if(!this.busy&&!this.complete&&this.models.length){nextStart=this.models[this.models.length-1].get("parent");if(nextStart===""){this.complete=true}else{this.options.start=nextStart;this.fetch({remove:false,success:function(){this.busy=false}},this)}}}});RB.DialogView=Backbone.View.extend({title:null,buttons:[],defaultOptions:{},initialize:function(options){options=options||{};this.options=options;if(options.title){this.title=options.title}if(options.buttons){this.buttons=options.buttons}this.visible=false},render:function(){return this},show:function(){if(!this.visible){this.render();this.$el.modalBox(_.defaults({title:_.result(this,"title"),buttons:this._getButtons(),destroy:function(){this.visible=false}},this.options,this.defaultOptions));this.visible=true}},hide:function(){if(this.visible){this.$el.modalBox("destroy")}},remove:function(){this.hide();_super(this).remove.call(this)},_getButtons:function(){var buttons=[];_.each(this.buttons,function(buttonInfo){var $button=$('<input type="button"/>').val(buttonInfo.label);if(buttonInfo.primary){$button.addClass("primary")}if(buttonInfo.danger){$button.addClass("danger")}if(buttonInfo.onClick){if(_.isFunction(buttonInfo.onClick)){$button.click(buttonInfo.onClick)}else{$button.click(_.bind(this[buttonInfo.onClick],this))}}buttons.push($button)},this);return buttons}});(function(){var CodeMirrorWrapper,TextAreaWrapper;CodeMirrorWrapper=Backbone.View.extend({initialize:function(options){var codeMirrorOptions={mode:{name:"gfm",classOverrides:{code:"rb-markdown-code",list1:"rb-markdown-list1",list2:"rb-markdown-list2",list3:"rb-markdown-list3"}},theme:"rb default",lineWrapping:true,electricChars:false,extraKeys:{Home:"goLineLeft",End:"goLineRight",Enter:"newlineAndIndentContinueMarkdownList","Shift-Tab":false,Tab:false}};if(options.autoSize){codeMirrorOptions.viewportMargin=Infinity}this._codeMirror=new CodeMirror(options.parentEl,codeMirrorOptions);this.setElement(this._codeMirror.getWrapperElement());if(this.options.minHeight!==undefined){this.$el.css("min-height",this.options.minHeight)}this._codeMirror.on("viewportChange",_.bind(function(){this.$el.triggerHandler("resize")},this));this._codeMirror.on("change",_.bind(function(){this.trigger("change")},this))},isDirty:function(initialValue){return(initialValue||"")!==this.getText()},setText:function(text){this._codeMirror.setValue(text)},getText:function(){return this._codeMirror.getValue()},getClientHeight:function(){return this._codeMirror.getScrollInfo().clientHeight},setSize:function(width,height){this._codeMirror.setSize(width,height);this._codeMirror.refresh()},focus:function(){this._codeMirror.focus()}});TextAreaWrapper=Backbone.View.extend({tagName:"textarea",initialize:function(options){this.options=options;if(options.autoSize){this.$el.autoSizeTextArea()}this.$el.css("width","100%").appendTo(options.parentEl).on("change keydown keyup keypress",_.bind(function(){this.trigger("change")},this));if(options.minHeight!==undefined){if(options.autoSize){this.$el.autoSizeTextArea("setMinHeight",options.minHeight)}else{this.$el.css("min-height",this.options.minHeight)}}},isDirty:function(initialValue){var value=this.el.value||"";return value.length!==initialValue.length||value!==initialValue},setText:function(text){this.el.value=text;if(this.options.autoSize){this.$el.autoSizeTextArea("autoSize")}},getText:function(){return this.el.value},getClientHeight:function(){
return this.el.clientHeight},setSize:function(width,height){if(width!==null){this.$el.innerWidth(width)}if(height!==null){if(height==="auto"&&this.options.autoSize){this.$el.autoSizeTextArea("autoSize",true)}else{this.$el.innerHeight(height)}}},focus:function(){this.$el.focus()}});RB.TextEditorView=Backbone.View.extend({className:"text-editor",defaultOptions:{autoSize:true,minHeight:70},events:{focus:"focus"},initialize:function(options){this._editor=null;this._prevClientHeight=null;this.options=_.defaults(options||{},this.defaultOptions);this.richText=!!this.options.richText;this._value=this.options.text||"";this._richTextDirty=false;if(this.options.bindRichText){this.bindRichTextAttr(this.options.bindRichText.model,this.options.bindRichText.attrName)}if(RB.UserSession.instance.get("defaultUseRichText")){this.setRichText(true)}},render:function(){this.$el.addClass(this.className);return this},setRichText:function(richText){if(richText===this.richText){return}if(this._editor){this._hideEditor();this.richText=richText;this._showEditor();this._richTextDirty=true;this.$el.triggerHandler("resize")}else{this.richText=richText}this.trigger("change:richText",richText);this.trigger("change")},bindRichTextAttr:function(model,attrName){this.setRichText(model.get(attrName));this.listenTo(model,"change:"+attrName,function(model,value){this.setRichText(value)})},bindRichTextCheckbox:function($checkbox){$checkbox.prop("checked",this.richText).on("change",_.bind(function(){this.setRichText($checkbox.prop("checked"))},this));this.on("change:richText",function(){$checkbox.prop("checked",this.richText)},this)},bindRichTextVisibility:function($el){$el.setVisible(this.richText);this.on("change:richText",function(){$el.setVisible(this.richText)},this)},isDirty:function(initialValue){return this._editor!==null&&(this._richTextDirty||this._editor.isDirty(initialValue||""))},setText:function(text){if(text!==this.getText()){if(this._editor){this._editor.setText(text)}else{this._value=text}}},getText:function(){return this._editor?this._editor.getText():this._value},setSize:function(width,height){if(this._editor){this._editor.setSize(width,height)}},show:function(){this.$el.show();this._showEditor()},hide:function(){this._hideEditor();this.$el.hide()},focus:function(){if(this._editor){this._editor.focus()}},_showEditor:function(){var EditorCls;if(this.richText){EditorCls=CodeMirrorWrapper}else{EditorCls=TextAreaWrapper}this._editor=new EditorCls({parentEl:this.el,autoSize:this.options.autoSize,minHeight:this.options.minHeight});this._editor.setText(this._value);this._value="";this._richTextDirty=false;this._prevClientHeight=null;this._editor.$el.on("resize",_.throttle(_.bind(function(){this.$el.triggerHandler("resize")},this),250));this.listenTo(this._editor,"change",_.throttle(_.bind(function(){var clientHeight;if(this._editor===null){return}clientHeight=this._editor.getClientHeight();if(clientHeight!==this._prevClientHeight){this._prevClientHeight=clientHeight;this.$el.triggerHandler("resize")}this.trigger("change")},this),500));this.focus()},_hideEditor:function(){if(this._editor){this._value=this._editor.getText();this._richTextDirty=false;this._editor.remove();this._editor=null;this.$el.empty()}}},{getInlineEditorOptions:function(options){var textEditor;return{matchHeight:false,multiline:true,createMultilineField:function(editor){var $editor=editor.element,origRichText;textEditor=new RB.TextEditorView(options);textEditor.render();$editor.one("beginEdit",function(){var $buttons=$editor.inlineEditor("buttons"),$markdownRef,$checkbox,$span;$span=$("<span/>").addClass("enable-markdown");$checkbox=$("<input/>").attr({id:_.uniqueId("markdown_check"),type:"checkbox"}).appendTo($span);textEditor.bindRichTextCheckbox($checkbox);$span.append($("<label/>").attr("for",$checkbox[0].id).text(gettext("Enable Markdown")));$buttons.append($span);$markdownRef=$("<a/>").addClass("markdown-info").attr({href:MANUAL_URL+"users/markdown/",target:"_blank"}).text(gettext("Markdown Reference")).setVisible(textEditor.richText).appendTo($buttons);textEditor.bindRichTextVisibility($markdownRef)});$editor.on("beginEdit",function(){textEditor._showEditor();origRichText=textEditor.richText});$editor.on("cancel",function(){textEditor._hideEditor();textEditor.setRichText(origRichText)});$editor.on("complete",function(){textEditor._hideEditor()});textEditor.$el.data("text-editor",textEditor);return textEditor.$el},setFieldValue:function(editor,value){textEditor.setText(value||"")},getFieldValue:function(){return textEditor.getText()},isFieldDirty:function(editor,initialValue){return textEditor.isDirty(initialValue)}}},getFromInlineEditor:function($editor){return $editor.inlineEditor("field").data("text-editor")}})})();RB.StarManager=Backbone.Model.extend({defaults:function(){return{objects:{},starred:{}}}});var Item,StoredItems;Item=RB.BaseResource.extend({defaults:_.defaults({objectID:null,baseURL:null,stored:false,loaded:true},RB.BaseResource.prototype.defaults),url:function(){var url=this.get("baseURL");if(this.get("stored")){url+=this.get("objectID")+"/"}return url},isNew:function(){return!this.get("stored")},toJSON:function(){return{object_id:this.get("objectID")||undefined}},parse:function(){}});StoredItems=RB.BaseResource.extend({defaults:_.defaults({visibility:false,addError:"",removeError:""},RB.BaseResource.prototype.defaults),url:function(){return this.get("url")},addImmediately:function(obj,options,context){var url=this.url(),item;if(url){item=new Item({objectID:obj.id,baseURL:url});item.save(options,context)}else if(options&&_.isFunction(options.error)){options.error.call({errorText:this.addError})}},removeImmediately:function(obj,options,context){var url=this.url(),item;if(url){item=new Item({objectID:obj.id,baseURL:url,stored:true});item.destroy(options,context)}else if(options&&_.isFunction(options.error)){options.error.call({errorText:this.removeError})}}});RB.UserSession=Backbone.Model.extend({defaults:{authenticated:false,diffsShowExtraWhitespace:false,fullName:null,loginURL:null,username:null,userPageURL:null,sessionURL:null,timezoneOffset:"0",watchedReviewGroupsURL:null,watchedReviewRequestsURL:null,archivedReviewRequestsURL:null,mutedReviewRequestsURL:null},initialize:function(){this.watchedGroups=new StoredItems({url:this.get("watchedReviewGroupsURL"),addError:gettext("Must log in to add a watched item."),removeError:gettext("Must log in to remove a watched item.")});this.watchedReviewRequests=new StoredItems({url:this.get("watchedReviewRequestsURL"),addError:gettext("Must log in to add a watched item."),removeError:gettext("Must log in to remove a watched item.")});this.archivedReviewRequests=new StoredItems({url:this.get("archivedReviewRequestsURL"),removeError:gettext("Must log in to remove a archived item."),addError:gettext("Must log in to add an archived item.")});this.mutedReviewRequests=new StoredItems({url:this.get("mutedReviewRequestsURL"),removeError:gettext("Must log in to remove a muted item."),addError:gettext("Must log in to add a muted item.")});this._bindCookie({attr:"diffsShowExtraWhitespace",cookieName:"show_ew",deserialize:function(value){return value!=="false"}})},toggleAttr:function(attr){this.set(attr,!this.get(attr))},getGravatarURL:function(size){return this.get("gravatarURL")+"&s="+size},_bindCookie:function(options){var deserialize=options.deserialize||_.identity,serialize=options.serialize||function(value){return value.toString()};this.set(options.attr,deserialize($.cookie(options.cookieName)));this.on("change:"+options.attr,function(model,value){$.cookie(options.cookieName,serialize(value),{path:SITE_ROOT})},this)}},{instance:null,ARCHIVED:"A",MUTED:"M",create:function(options){console.assert(!RB.UserSession.instance,"UserSession.create can only be called once.");RB.UserSession.instance=new RB.UserSession(options);return RB.UserSession.instance}});RB.HeaderView=Backbone.View.extend({SEARCH_SUMMARY_TRIM_LEN:28,DESKTOP_SEARCH_RESULTS_WIDTH:350,events:{"click #nav_toggle":"_handleNavClick","touchstart #nav_toggle":"_handleNavClick","focus #search_field":"_closeMobileMenu"},initialize:function(){this._mobileMenuOpened=false;this._$window=$(window);this._$body=$(document.body);this._$navToggle=$("#nav_toggle");this._$mobileMenuMask=$('<div id="mobile_menu_mask"/>').on("click touchstart",_.bind(this._closeMobileMenu,this)).insertAfter($("#mobile_navbar_container"));this._setupSearch();this._$window.on("resize",_.throttle(_.bind(function(){this._setMobileMode(this._$navToggle.is(":visible"))},this),100))},_handleNavClick:function(e){e.stopPropagation();e.preventDefault();this._setMobileMenuOpened(!this._mobileMenuOpened)},_setMobileMode:function(inMobileMode){if(inMobileMode===this._inMobileMode){return}if(!inMobileMode){this._setMobileMenuOpened(false)}this._inMobileMode=inMobileMode},_closeMobileMenu:function(){this._setMobileMenuOpened(false);return false},_setupSearch:function(){this._$search=$("#search_field").rbautocomplete({formatItem:_.bind(function(data){var s;if(data.username){s=data.username;if(data.fullname){s+=" <span>("+_.escape(data.fullname)+")</span>"}}else if(data.name){s=data.name;s+=" <span>("+_.escape(data.display_name)+")</span>"}else if(data.summary){if(data.summary.length<this.SEARCH_SUMMARY_TRIM_LEN){s=data.summary}else{s=data.summary.substring(0,this.SEARCH_SUMMARY_TRIM_LEN)}s+=" <span>("+_.escape(data.id)+")</span>"}return s},this),matchCase:false,multiple:false,clickToURL:true,selectFirst:false,width:this.DESKTOP_SEARCH_RESULTS_WIDTH,enterToURL:true,resultsParentEl:$("#page-container"),resultsClass:"ui-autocomplete-results search-results",parse:function(data){var jsonData=data,jsonDataSearch=jsonData.search,parsed=[],objects=["users","groups","review_requests"],values=["username","name","summary"],value,items,i,j;for(j=0;j<objects.length;j++){items=jsonDataSearch[objects[j]];for(i=0;i<items.length;i++){value=items[i];if(j!==2){parsed.push({data:value,value:value[values[j]],result:value[values[j]]})}else if(value["public"]){value.url=SITE_ROOT+"r/"+value.id;parsed.push({data:value,value:value[values[j]],result:value[values[j]]})}}}return parsed},url:SITE_ROOT+"api/"+"search/"})},_setMobileMenuOpened:function(opened){if(opened===this._mobileMenuOpened){return}if(opened){this._$mobileMenuMask.show();_.defer(_.bind(function(){this._$body.addClass("mobile-menu-open")},this))}else{this._$body.removeClass("mobile-menu-open");_.delay(_.bind(function(){this._$mobileMenuMask.hide()},this),300)}this._mobileMenuOpened=opened}});RB.CollectionView=Backbone.View.extend({itemViewType:null,initialize:function(options){var collection=options.collection;if(options.itemViewType){this.itemViewType=options.itemViewType}this.itemViewOptions=options.itemViewOptions||{};this.collection=collection;this.views=[];collection.each(this._onAdded,this);this.listenTo(collection,"add",this._onAdded);this.listenTo(collection,"remove",this._onRemoved);this.listenTo(collection,"sort",this._onSorted);this.listenTo(collection,"reset",this._onReset)},render:function(){this._rendered=true;this.$el.empty();this.views.forEach(function(view){this.$el.append(view.render().el)},this);return this},_onAdded:function(item){var view;console.assert(this.itemViewType,"itemViewType must be defined by the subclass");view=new this.itemViewType(_.defaults({model:item},this.itemViewOptions));this.views.push(view);if(this._rendered){this.$el.append(view.render().el)}},_onRemoved:function(item){var toRemove=_.find(this.views,function(view){return view.model===item});this.views=_.without(this.views,toRemove);if(this._rendered){toRemove.remove()}},_onSorted:function(){var views=this.views;this.views=this.collection.map(function(model){var view=_.find(views,function(view){return view.model===model});views=_.without(views,view);return view});if(this._rendered){this.$el.children().detach();this.views.forEach(function(view){this.$el.append(view.$el)},this)}},_onReset:function(){this.views.forEach(function(view){view.remove()});this.views=[];this.collection.each(this._onAdded,this)}});RB.StarManagerView=Backbone.View.extend({events:{"click .star":"_toggleStar"},initialize:function(options){var objects=this.model.get("objects"),starred=this.model.get("starred");options=options||{};this._datagridMode=options.datagridMode;this.$("div.star").each(function(idx,el){var $el=$(el),objType=$el.attr("data-object-type"),objID=$el.attr("data-object-id"),objStarred=parseInt($el.attr("data-starred"),10)===1,obj;if(objType==="reviewrequests"){obj=new RB.ReviewRequest({id:objID})}else if(objType==="groups"){obj=new RB.ReviewGroup({id:objID})}else if(objType!==undefined){console.assert("Unknown star object type: %s",objType)}else{return}objects[objID]=obj;starred[objID]=objStarred});this._watchUpdates=false;this._toUpdate={};if(this._datagridMode){this.$el.on("datagridDisplayModeChanged",_.bind(function($grid,options){var objID;if(options.mode==="desktop"){for(objID in this._toUpdate){if(this._toUpdate.hasOwnProperty(objID)){this._updateStarColumn(objID)}}this._watchUpdates=false;this._toUpdate={}}else if(options.mode==="mobile"){this._watchUpdates=true}},this));if(this.$el.attr("data-datagrid-display-mode")==="mobile"){this._watchUpdates=true}}},_updateStarColumn:function(objID){var $el=this.$('.star[data-object-id="'+objID+'"]'),starred=this.model.get("starred")[objID];$el.toggleClass("rb-icon-star-on",starred).toggleClass("rb-icon-star-off",!starred).attr("title",starred?gettext("Starred"):gettext("Click to star"))},_toggleStar:function(e){var $target=$(e.target),objID=$target.attr("data-object-id"),obj=this.model.get("objects")[objID],starred=this.model.get("starred"),objStarred=!starred[objID];e.preventDefault();e.stopPropagation();obj.setStarred(objStarred);starred[objID]=objStarred;if(this._watchUpdates){if(this._toUpdate.hasOwnProperty(objID)){delete this._toUpdate[objID]}else{this._toUpdate[objID]=true}}$target.toggleClass("rb-icon-star-on",objStarred).toggleClass("rb-icon-star-off",!objStarred).attr("title",objStarred?gettext("Starred"):gettext("Click to star"))}})}).call(this);